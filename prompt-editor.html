<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <!-- ✅ AUTH GUARD (واحد فقط) -->
  <script>
    (function () {
      const AUTH_KEY = "HA_AUTH_OK";
      const authed = sessionStorage.getItem(AUTH_KEY) === "1";
      if (!authed) {
        const next = encodeURIComponent(location.pathname.split("/").pop() || "index.html");
        location.replace("./login.html?next=" + next);
      }
    })();
  </script>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>HA - Prompt Editor</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;700;900&display=swap" rel="stylesheet">

<style>
:root{
  --bg-dark:#0b1016;
  --bg-card:#121722;
  --accent-orange:#ff9d2f;
  --accent-teal:#14e0c3;
  --grad-orange: rgba(255,140,0,0.18);
  --grad-teal: rgba(0,180,160,0.100);
  --text:#ffffff;
  --muted:#bfc7d6;
  --radius:16px;
  --shadow:0 18px 55px rgba(0,0,0,0.35);
}

*{margin:0;padding:0;box-sizing:border-box;font-family:'Cairo',sans-serif;}
body{
  background:
    radial-gradient(circle at 70% 20%, var(--grad-orange), transparent 44%),
    radial-gradient(circle at 20% 55%, var(--grad-teal), transparent 44%),
    var(--bg-dark);
  color:var(--text);
  overflow-x:hidden;
}
a{color:inherit;text-decoration:none;}

nav{
  position:sticky; top:0; z-index:999;
  padding:14px 5%;
  display:flex; align-items:center; justify-content:space-between; gap:14px;
  background:rgba(10,15,25,0.68);
  backdrop-filter: blur(14px);
  border-bottom:1px solid rgba(255,255,255,0.06);
}
.brand{display:flex; align-items:center; gap:12px; min-width:240px;}
.brandLogo{width:38px;height:38px;border-radius:12px;object-fit:cover;box-shadow:0 12px 30px rgba(0,0,0,0.35);}
.brandText .title{font-weight:900;font-size:16px;line-height:1.2;}
.brandText .sub{font-size:12px;color:var(--muted);opacity:.92;}
.topBtn{
  background:var(--accent-teal); color:#001018;
  padding:10px 16px; border-radius:14px; font-weight:900; transition:.25s;
  white-space:nowrap;
}
.topBtn:hover{transform:translateY(-1px); filter:brightness(1.05);}

.container{padding:22px 8% 80px;}
@media(max-width:980px){ .container{padding:18px 6% 70px;} }

.head{
  display:flex; align-items:flex-end; justify-content:space-between;
  gap:16px; margin:22px 0 14px;
}
.head h1{font-size:34px;font-weight:900;line-height:1.2;}
.head p{color:var(--muted);line-height:1.8;max-width:760px;}

.grid{
  display:grid;
  grid-template-columns: 1fr 1fr;
  gap:12px;
  margin:14px 0 12px;
}
@media(max-width:980px){ .grid{grid-template-columns:1fr;} }

.card{
  background:rgba(18,23,34,0.86);
  border:1px solid rgba(255,255,255,0.06);
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  padding:14px;
}

.labelRow{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
  margin-bottom:8px;
}

.label{font-weight:900; color:#fff;}
.hint{color:var(--muted); font-size:12px; line-height:1.6; margin-top:6px;}

.input, .area{
  width:100%;
  background:rgba(0,0,0,0.22);
  border:1px solid rgba(255,255,255,0.10);
  color:#fff;
  border-radius:14px;
  padding:12px 14px;
  outline:none;
  font-weight:700;
  line-height:1.8;
}
.area{min-height:140px; resize:vertical; white-space:pre-wrap;}
.bigArea{min-height:360px;}

.actions{
  display:flex; gap:10px; flex-wrap:wrap;
  margin-top:12px;
}
.btn{
  padding:10px 14px;border-radius:14px;font-weight:900;
  border:1px solid rgba(255,255,255,0.10);
  background:rgba(0,0,0,0.22);
  color:#fff; cursor:pointer; transition:.25s;
}
.btn:hover{transform:translateY(-1px);}
.orange{background:var(--accent-orange); color:#1a0f00; border-color:transparent;}
.teal{background:rgba(39,211,177,0.10); color:var(--accent-teal); border-color:rgba(39,211,177,0.45);}

.previewWrap{position:relative;}
.highlightLayer{
  position:absolute; inset:0;
  padding:12px 14px;
  border-radius:14px;
  pointer-events:none;
  white-space:pre-wrap;
  line-height:1.8;
  font-weight:700;
  color:transparent;
  overflow:auto;
}
.hl2{
  background:rgba(20,224,195,0.12);
  box-shadow: inset 0 0 0 1px rgba(20,224,195,0.22);
  border-radius:8px;
  padding:0 2px;
}

/* ✅ زر مسح مكتوب عليه "مسح" */
.clearBtn{
  padding:8px 12px;
  border-radius:12px;
  border:1px solid rgba(255,255,255,0.10);
  background:rgba(0,0,0,0.22);
  color:#fff;
  cursor:pointer;
  transition:.25s;
  font-weight:900;
  font-size:12px;
  white-space:nowrap;
}
.clearBtn:hover{transform:translateY(-1px);}
.clearBtn:active{transform:translateY(0px) scale(.98);}

.toast{
  position:fixed; bottom:18px; right:18px; z-index:9999;
  background:rgba(18,23,34,0.92);
  border:1px solid rgba(255,255,255,0.10);
  border-radius:14px;
  padding:12px 14px;
  box-shadow:0 18px 55px rgba(0,0,0,0.45);
  color:#fff;
  display:none;
  font-weight:900;
}
.toast.show{display:block;}

/* ✅ MOBILE NAV CENTER FIX */
@media (max-width: 768px){
  nav{
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
    gap: 12px;
    padding: 14px 16px;
  }

  .brand{
    min-width: auto;
    width: 100%;
    justify-content: center;
    text-align: center;
  }

  .brandText{ text-align: center; }

  nav .actions{
    width: 100%;
    margin: 0 !important;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 10px;
    flex-wrap: wrap;
  }

  .topBtn{
    width: min(320px, 92%);
    text-align: center;
    display: inline-flex;
    justify-content: center;
    align-items: center;
  }
}
</style>
</head>

<body>

<nav>
  <div class="brand">
    <img class="brandLogo" src="assets/hero/hero.png" alt="logo" loading="eager" decoding="async">
    <div class="brandText">
      <div class="title">HA - Visual School</div>
      <div class="sub">Prompt Editor</div>
    </div>
  </div>

  <div class="actions" style="margin:0">
    <a class="topBtn" href="./index.html">الرئيسية</a>
    <a class="topBtn" href="./prompts.html">مكتبة التوجلات</a>
  </div>
</nav>

<div class="container">
  <div class="head">
    <div>
      <h1>محرّر البرومبت</h1>
      <p>عدّل <b>5</b> أجزاء بسرعة: <b>Context</b> + <b>Main Title</b> + <b>Secondary Text</b> + <b>Text Style</b> + <b>Character</b>. والبرومبت الكامل يتحدّث تلقائيًا مع هايلايت واضح.</p>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="labelRow">
        <div class="label">1) TEXT CONTEXT</div>
        <button class="clearBtn" type="button" data-clear="ctx">مسح</button>
      </div>
      <textarea id="ctx" class="area" placeholder="علي سبيل المثال لو مدرس تاريخ هيكون في عصر تاريخي وهكذا ااكتب المجال/المحتوى هنا..."></textarea>
      <div class="hint">بيتكتب تحت: <b>Selected context</b></div>
    </div>

    <div class="card">
      <div class="labelRow">
        <div class="label">2) MAIN TITLE</div>
        <button class="clearBtn" type="button" data-clear="mainTitle">مسح</button>
      </div>
      <textarea id="mainTitle" class="area" placeholder=' "اكتب هنا العنوان الاساسي"'></textarea>
      <div class="hint">بيتكتب تحت: <b>Main Title Text:</b></div>
    </div>

    <div class="card">
      <div class="labelRow">
        <div class="label">3) SECONDARY TEXT</div>
        <button class="clearBtn" type="button" data-clear="secondaryText">مسح</button>
      </div>
      <textarea id="secondaryText" class="area" placeholder='مثال: “هنا اسمك الثنائي لو حبيت ”'></textarea>
      <div class="hint">بيتكتب تحت: <b>Secondary Text:</b></div>
    </div>

    <div class="card">
      <div class="labelRow">
        <div class="label">4) TEXT STYLE</div>
        <button class="clearBtn" type="button" data-clear="style">مسح</button>
      </div>
      <textarea id="style" class="area" placeholder="اكتب Text Style Preset..."></textarea>
      <div class="hint">بيتكتب تحت: <b>Text Style Preset Name</b></div>
    </div>

    <div class="card">
      <div class="labelRow">
        <div class="label">5) CHARACTER ARCHETYPE / CLOTHES</div>
        <button class="clearBtn" type="button" data-clear="char">مسح</button>
      </div>
      <textarea id="char" class="area" placeholder="اكتب Character Archetype / الملابس..."></textarea>
      <div class="hint">بيتكتب تحت: <b>Character Archetype</b></div>
    </div>
  </div>

  <div class="card">
    <div class="labelRow">
      <div class="label">البرومبت الكامل (هايلايت تلقائي للخمس مناطق)</div>
      <button class="clearBtn" type="button" data-clear="full">مسح</button>
    </div>

    <div class="previewWrap">
      <div id="hl" class="highlightLayer"></div>
      <textarea id="full" class="area bigArea input" spellcheck="false"
        placeholder="الصق البرومبت الضخم هنا مرة واحدة..."></textarea>
    </div>

    <div class="actions">
      <button class="btn orange" id="btnCopy" type="button">Copy</button>
      <button class="btn teal" id="btnSync" type="button">تحديث الهايلايت + استخراج الـ5 أجزاء</button>

      <a class="btn teal" href="./prompts.html?group=domain">برومبت تغيير المجال</a>
      <a class="btn teal" href="./prompts.html?group=clothes">برومبت تغيير اللبس</a>
      <a class="btn teal" href="./prompts.html?group=text">برومبت تغيير التكست ستايل</a>
      <a class="btn teal" href="./prompts.html?group=name">برومبت تغيير الشخصية</a>
    </div>

    <div class="hint">لو عدّلت في الخانات فوق، التحديث بيحصل تلقائيًا بعد توقف بسيط عن الكتابة. وتقدر تضغط <b>تحديث</b> يدويًا في أي وقت.</div>
  </div>
</div>

<div class="toast" id="toast">تم النسخ ✅</div>

<script>
const $ = (id)=>document.getElementById(id);
const toast = $("toast");

function showToast(msg="تم النسخ ✅"){
  toast.textContent = msg;
  toast.classList.add("show");
  clearTimeout(showToast.t);
  showToast.t = setTimeout(()=>toast.classList.remove("show"), 1200);
}

async function copyText(t){
  try{
    await navigator.clipboard.writeText(t);
    showToast();
  }catch(e){
    const ta=document.createElement("textarea");
    ta.value=t; document.body.appendChild(ta);
    ta.select(); document.execCommand("copy");
    ta.remove();
    showToast();
  }
}

const MARKERS = {
  ctx:   { start: /Selected context[\s\S]*?:/i },
  main:  { start: /Main Title Text\s*:/i },
  sec:   { start: /Secondary Text\s*:/i },
  style: { start: /Text Style Preset Name\s*:/i },
  char:  { start: /Character Archetype\s*:/i },
};

function extractBlock(full, startRegex, allStarts){
  const m = full.match(startRegex);
  if(!m) return "";
  const startIdx = m.index + m[0].length;

  let endIdx = full.length;
  for(const rx of allStarts){
    const mm = rx.exec(full.slice(startIdx));
    if(mm && (startIdx + mm.index) < endIdx){
      endIdx = startIdx + mm.index;
    }
    rx.lastIndex = 0;
  }
  return full.slice(startIdx, endIdx).trim();
}

function replaceBlock(full, startRegex, allStarts, newText){
  const m = full.match(startRegex);
  if(!m) return full;
  const startLabelEnd = m.index + m[0].length;

  let endIdx = full.length;
  for(const rx of allStarts){
    const mm = rx.exec(full.slice(startLabelEnd));
    if(mm && (startLabelEnd + mm.index) < endIdx){
      endIdx = startLabelEnd + mm.index;
    }
    rx.lastIndex = 0;
  }

  const before = full.slice(0, startLabelEnd);
  const after  = full.slice(endIdx);
  const insert = "\n" + (newText || "").trim() + "\n";
  return before + insert + after;
}

function escapeHtml(s){
  return String(s ?? "")
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function buildHighlight(full){
  const lines = full.split("\n");
  const keys = [
    "Selected context",
    "Main Title Text:",
    "Secondary Text:",
    "Text Style Preset Name:",
    "Character Archetype:"
  ];

  return lines.map(line=>{
    const t = line.trim();
    if(keys.some(k => t.toLowerCase().startsWith(k.toLowerCase()))){
      return `<span class="hl2">${escapeHtml(line)}</span>`;
    }
    return escapeHtml(line);
  }).join("\n");
}

const ctx = $("ctx");
const mainTitle = $("mainTitle");
const secondaryText = $("secondaryText");
const char = $("char");
const style = $("style");
const full = $("full");
const hl = $("hl");

function syncScroll(){
  hl.scrollTop = full.scrollTop;
  hl.scrollLeft = full.scrollLeft;
}
full.addEventListener("scroll", syncScroll);

function refreshHighlight(){
  hl.innerHTML = buildHighlight(full.value);
  syncScroll();
}

function extractToFields(){
  const text = full.value || "";
  const allStarts = [
    MARKERS.ctx.start, MARKERS.main.start, MARKERS.sec.start,
    MARKERS.style.start, MARKERS.char.start
  ];

  ctx.value = extractBlock(text, MARKERS.ctx.start, allStarts);
  mainTitle.value = extractBlock(text, MARKERS.main.start, allStarts);
  secondaryText.value = extractBlock(text, MARKERS.sec.start, allStarts);
  style.value = extractBlock(text, MARKERS.style.start, allStarts);
  char.value  = extractBlock(text, MARKERS.char.start, allStarts);

  refreshHighlight();
  showToast("تم استخراج الأقسام ✅");
}

function applyFieldsToFull(){
  let text = full.value || "";
  const allStarts = [
    MARKERS.ctx.start, MARKERS.main.start, MARKERS.sec.start,
    MARKERS.style.start, MARKERS.char.start
  ];

  if(ctx.value.trim()) text = replaceBlock(text, MARKERS.ctx.start, allStarts, ctx.value);
  if(mainTitle.value.trim()) text = replaceBlock(text, MARKERS.main.start, allStarts, mainTitle.value);
  if(secondaryText.value.trim()) text = replaceBlock(text, MARKERS.sec.start, allStarts, secondaryText.value);
  if(style.value.trim()) text = replaceBlock(text, MARKERS.style.start, allStarts, style.value);
  if(char.value.trim()) text = replaceBlock(text, MARKERS.char.start, allStarts, char.value);

  full.value = text;
  refreshHighlight();
  showToast("تم تحديث البرومبت ✅");
}

const KEY = "HA_PROMPT_EDITOR_FULL";
const saved = localStorage.getItem(KEY);
if(saved && !full.value) full.value = saved;

refreshHighlight();

full.addEventListener("input", ()=>{
  refreshHighlight();
  clearTimeout(full._t);
  full._t = setTimeout(()=>localStorage.setItem(KEY, full.value || ""), 250);
});

$("btnCopy").addEventListener("click", ()=>copyText(full.value || ""));
$("btnSync").addEventListener("click", ()=>{
  applyFieldsToFull();
  extractToFields();
});

function debounce(fn, wait=250){
  let t;
  return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), wait); };
}
const autoApply = debounce(applyFieldsToFull, 300);

[ctx, mainTitle, secondaryText, char, style].forEach(el=>{
  el.addEventListener("input", autoApply);
});

/* ✅ Clear per field */
function clearBox(id){
  const el = $(id);
  if(!el) return;

  el.value = "";

  if(id === "full"){
    localStorage.removeItem(KEY);
    refreshHighlight();
    showToast("تم مسح البرومبت الكامل ✅");
    el.focus();
    return;
  }

  applyFieldsToFull();
  refreshHighlight();
  showToast("تم مسح الحقل ✅");
  el.focus();
}

document.querySelectorAll("[data-clear]").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    clearBox(btn.getAttribute("data-clear"));
  });
});
</script>

</body>
</html>